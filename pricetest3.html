<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Прайс-лист игр — оптимизированный</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root{--bg:#0f0f15;--card:#181821;--text:#e0e0ff;--muted:#a0a0cc;--accent:#00ff9d;--border:#2a2a3a}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Inter',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .container{max-width:1100px;margin:0 auto;padding:16px}
        header{text-align:center;margin-bottom:1rem}
        #logo{width:68px;height:68px;border:3px solid var(--accent);box-shadow:0 0 20px rgba(0,255,157,0.18);border-radius:50%;object-fit:cover;margin-bottom:.8rem}
        h1{font-size:2.2rem;font-weight:700;background:linear-gradient(135deg,#fff,var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:.4rem}
        .subtitle{color:var(--muted);font-weight:500}

        /* controls */
        .controls{position:sticky;top:0;background:var(--bg);z-index:90;padding:12px 0;border-bottom:1px solid var(--border)}
        .bar{display:flex;gap:12px;align-items:center;justify-content:center;max-width:720px;margin:0 auto}
        .search-box{position:relative;flex:1;min-width:140px}
        #search{width:100%;padding:12px 44px 12px 44px;border:2px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-size:1rem}
        .icon-left{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:var(--muted)}
        #clear{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;opacity:0;transition:opacity .25s}
        #clear.show{opacity:1}
        .sort-btn{background:var(--card);border:2px solid var(--border);color:var(--text);width:52px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer}
        .selection{display:flex;gap:12px;justify-content:center;margin:12px 0;flex-wrap:wrap}
        .btn{padding:10px 18px;border-radius:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:10px}
        .btn-copy{background:var(--accent);color:#000;border:none;opacity:0;pointer-events:none}
        .btn-copy.visible{opacity:1;pointer-events:auto}
        .btn-clear{background:var(--card);color:var(--muted);border:2px solid var(--border);opacity:0;pointer-events:none}
        .btn-clear.visible{opacity:1;pointer-events:auto}

        .hint{max-width:720px;margin:0 auto 12px;background:linear-gradient(135deg,rgba(0,255,157,0.06),rgba(0,255,157,0.02));border:1px solid rgba(0,255,157,0.12);padding:10px;border-radius:12px;color:var(--text);text-align:center}

        /* layout */
        .table-wrap{background:var(--card);border-radius:14px;overflow:hidden;border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,0.35)}
        table{width:100%;border-collapse:collapse}
        thead{background:linear-gradient(90deg,#1a1a2e,#16213e)}
        th,td{padding:12px 14px;text-align:left}
        th:first-child,td:first-child{text-align:center;width:60px}
        td:last-child{text-align:right;font-weight:700;color:var(--accent)}
        tr:hover{background:rgba(0,255,157,0.04)}
        tr.selected{background:rgba(0,255,157,0.12)}

        /* mobile cards */
        .cards{display:none}
        .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 14px 14px 64px;margin-bottom:12px;position:relative;display:flex;align-items:center;justify-content:space-between}
        .card label{position:absolute;left:14px;top:50%;transform:translateY(-50%);width:34px;height:34px;border-radius:8px;border:2px solid #666;display:flex;align-items:center;justify-content:center;background:var(--card)}
        .card input[type="checkbox"]{position:absolute;left:14px;top:50%;transform:translateY(-50%);opacity:0;width:34px;height:34px}
        .card .title{font-weight:600;overflow-wrap:break-word}
        .price{font-weight:700;color:var(--accent);white-space:nowrap}

        /* feedback */
        .copy-feedback{position:absolute;background:var(--accent);color:#000;padding:6px 10px;border-radius:8px;font-weight:700;font-size:.85rem;opacity:0;pointer-events:none;transition:opacity .18s}
        .copy-feedback.show{opacity:1}

        /* simplified shadows and heavy effects on mobile */
        @media (max-width:768px){
            .table-wrap{display:none}
            .cards{display:block}
            .controls{backdrop-filter:none}
            #logo{width:58px;height:58px}
            .card{padding-left:68px;box-shadow:0 6px 18px rgba(0,0,0,0.25)}
        }

        /* performance hints */
        .card,.game-row{will-change:transform,background}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <img id="logo" src="resources/orig.png" alt="Логотип" onerror="this.src='https://via.placeholder.com/80/00ff9d/000000?text=Gamepad'">
            <h1>ПРАЙС-ЛИСТ ИГР</h1>
            <p class="subtitle">Актуальные цены · Быстрая версия</p>
        </header>

        <div class="controls">
            <div class="bar">
                <div class="search-box">
                    <i class="fas fa-search icon-left" aria-hidden></i>
                    <input id="search" type="text" placeholder="Поиск"> 
                    <button id="clear">×</button>
                </div>
                <button id="sortBtn" class="sort-btn" title="Сортировать по цене"><i class="fas fa-sort"></i></button>
            </div>
        </div>

        <div class="selection">
            <button id="copySelected" class="btn btn-copy"><i class="fas fa-copy"></i> Скопировать выбранное (0)</button>
            <button id="clearSel" class="btn btn-clear"><i class="fas fa-times"></i> Снять выделение</button>
        </div>

        <div class="hint"><strong>Подсказка:</strong> Нажмите зелёную кнопку — скопируется одна игра. Новое: множественный выбор.</div>

        <div class="table-wrap" aria-hidden="false">
            <table id="priceTable" cellspacing="0">
                <thead><tr><th></th><th>Название игры</th><th>Цена</th></tr></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>

        <div class="cards" id="cardsList" aria-hidden="true"></div>
    </div>

    <template id="rowTemplate">
        <tr class="game-row">
            <td><input type="checkbox" class="row-cb"></td>
            <td>
                <div style="display:flex;align-items:center;gap:12px">
                    <button class="copy-single" aria-label="Скопировать" title="Скопировать" style="width:36px;height:36px;border-radius:10px;border:1px solid rgba(0,255,157,0.18);background:rgba(0,255,157,0.08);cursor:pointer"><i class="fas fa-copy"></i>
                    <span class="copy-feedback">Скопировано!</span></button>
                    <span class="name"></span>
                </div>
            </td>
            <td class="price-col"></td>
        </tr>
    </template>

    <template id="cardTemplate">
        <div class="card">
            <input type="checkbox" class="row-cb">
            <label></label>
            <div style="flex:1;min-width:0">
                <div class="title"></div>
                <div class="price"></div>
            </div>
            <button class="copy-single" style="width:36px;height:36px;border-radius:10px;border:1px solid rgba(0,255,157,0.18);background:rgba(0,255,157,0.08);cursor:pointer"><i class="fas fa-copy"></i><span class="copy-feedback">Скопировано!</span></button>
        </div>
    </template>

    <script>
    (function(){
        // CONFIG
        const sheetId = '1MzBvxOzI6Yn3sRkAdJZeG-mdSeoQwPRYKv9thY9_U-0';
        const apiKey = 'AIzaSyAz6NMjP-Sgq2P9FgGOc8T1prYM57b-An0';
        const range = 'ru price!A:B';
        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
        const CACHE_TTL = 1000 * 60 * 5; // 5 min
        const MOBILE_BREAK = 768;

        // STATE
        let allGames = [];
        let filtered = [];
        let currentSort = 'none';
        let selectedCount = 0;
        const isMobile = () => window.matchMedia(`(max-width: ${MOBILE_BREAK}px)`).matches;

        // ELEMENTS
        const search = document.getElementById('search');
        const clearBtn = document.getElementById('clear');
        const tableBody = document.getElementById('tableBody');
        const cardsList = document.getElementById('cardsList');
        const copySelected = document.getElementById('copySelected');
        const clearSel = document.getElementById('clearSel');
        const sortBtn = document.getElementById('sortBtn');
        const rowTpl = document.getElementById('rowTemplate');
        const cardTpl = document.getElementById('cardTemplate');

        // UTIL
        function debounce(fn, ms=250){let t; return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args), ms);}};
        function qs(selector, root=document){return root.querySelector(selector)}
        function qsa(selector, root=document){return Array.from(root.querySelectorAll(selector))}

        // STORAGE
        function saveCache(data){localStorage.setItem('priceCache', JSON.stringify(data)); localStorage.setItem('priceCacheTime', Date.now());}
        function readCache(){try{const raw = localStorage.getItem('priceCache'); const t = +localStorage.getItem('priceCacheTime')||0; if(raw && Date.now()-t < CACHE_TTL) return JSON.parse(raw)}catch(e){} return null}

        // RENDER
        function renderList(){
            const q = search.value.trim().toLowerCase();
            filtered = allGames.filter(g => g.name.toLowerCase().includes(q));
            if(currentSort === 'priceAsc') filtered.sort((a,b)=>Number(a.num)-Number(b.num));
            if(currentSort === 'priceDesc') filtered.sort((a,b)=>Number(b.num)-Number(a.num));

            // Only render the active layout
            if(isMobile()){
                renderCards(filtered);
                document.querySelector('.table-wrap').setAttribute('aria-hidden', 'true');
                cardsList.setAttribute('aria-hidden','false');
            } else {
                renderTable(filtered);
                document.querySelector('.table-wrap').setAttribute('aria-hidden', 'false');
                cardsList.setAttribute('aria-hidden','true');
            }
            updateSelectionUI();
        }

        function renderTable(items){
            // batch DOM ops with fragment
            tableBody.innerHTML = '';
            const frag = document.createDocumentFragment();
            for(const g of items){
                const node = rowTpl.content.cloneNode(true);
                const tr = node.querySelector('tr');
                qs('.name', node).textContent = g.name;
                qs('.price-col', node).textContent = g.price + ' руб.';
                // store data on element for delegation
                tr.dataset.name = g.name; tr.dataset.price = g.price;
                frag.appendChild(node);
            }
            tableBody.appendChild(frag);
        }

        function renderCards(items){
            cardsList.innerHTML = '';
            const frag = document.createDocumentFragment();
            for(const g of items){
                const node = cardTpl.content.cloneNode(true);
                const card = node.querySelector('.card');
                qs('.title', node).textContent = g.name;
                qs('.price', node).textContent = g.price + ' руб.';
                card.dataset.name = g.name; card.dataset.price = g.price;
                frag.appendChild(node);
            }
            cardsList.appendChild(frag);
        }

        // EVENTS (delegated)
        // Clicks for copy-single and changes for checkboxes
        document.addEventListener('click', async (e)=>{
            const copyBtn = e.target.closest('.copy-single');
            if(copyBtn){
                e.preventDefault();
                const container = copyBtn.closest('tr') || copyBtn.closest('.card');
                const name = container?.dataset?.name || qs('.name', container)?.textContent || qs('.title', container)?.textContent;
                const price = container?.dataset?.price || qs('.price-col', container)?.textContent || qs('.price', container)?.textContent;
                const text = `${name} — ${price.replace(/руб\.?/,'').trim()} руб.`;
                try{await navigator.clipboard.writeText(text);}catch(e){}
                const fb = copyBtn.querySelector('.copy-feedback'); if(fb){fb.classList.add('show'); setTimeout(()=>fb.classList.remove('show'),1000)}
            }
        });

        // checkbox change - delegation
        document.addEventListener('change', (e)=>{
            if(e.target.classList.contains('row-cb')){
                const cb = e.target;
                const container = cb.closest('tr') || cb.closest('.card');
                const checked = cb.checked;
                container?.classList.toggle('selected', checked);
                selectedCount += checked ? 1 : -1;
                // clamp
                if(selectedCount < 0) selectedCount = 0;
                updateSelectionUI();
            }
        });

        function updateSelectionUI(){
            copySelected.textContent = '';
            copySelected.innerHTML = `<i class="fas fa-copy"></i> Скопировать выбранное (${selectedCount})`;
            copySelected.classList.toggle('visible', selectedCount>0);
            clearSel.classList.toggle('visible', selectedCount>0);
        }

        // copy selected
        copySelected.addEventListener('click', ()=>{
            if(selectedCount === 0) return;
            // collect checked boxes from current view
            const checked = qsa('.row-cb:checked');
            const lines = checked.map(cb => {
                const container = cb.closest('tr') || cb.closest('.card');
                const name = container?.dataset?.name || qs('.name', container)?.textContent || qs('.title', container)?.textContent;
                const price = container?.dataset?.price || qs('.price-col', container)?.textContent || qs('.price', container)?.textContent;
                return `${name} — ${price.replace(/руб\.?/,'').trim()} руб.`;
            });
            navigator.clipboard.writeText(lines.join('\n')).then(()=>{
                copySelected.innerHTML = '<i class="fas fa-check"></i> Скопировано!';
                setTimeout(()=>updateSelectionUI(),1200);
            });
        });

        clearSel.addEventListener('click', ()=>{
            qsa('.row-cb:checked').forEach(cb=>{cb.checked=false; const c=cb.closest('tr')||cb.closest('.card'); c?.classList.remove('selected')});
            selectedCount = 0; updateSelectionUI();
        });

        // sort
        sortBtn.addEventListener('click', ()=>{
            const order = ['none','priceAsc','priceDesc'];
            currentSort = order[(order.indexOf(currentSort)+1)%3];
            const icon = qs('i', sortBtn);
            icon.className = currentSort==='priceAsc'? 'fas fa-sort-amount-down-alt' : currentSort==='priceDesc'? 'fas fa-sort-amount-up-alt' : 'fas fa-sort';
            renderList();
        });

        // search debounce
        const onSearch = debounce(()=>{clearBtn.classList.toggle('show', search.value.length>0); // small delay render
            requestAnimationFrame(renderList);
        }, 220);
        search.addEventListener('input', onSearch);
        clearBtn.addEventListener('click', ()=>{search.value=''; clearBtn.classList.remove('show'); renderList(); search.focus();});

        // resize: re-render if breakpoint crosses
        let lastIsMobile = isMobile();
        window.addEventListener('resize', debounce(()=>{
            const nowMobile = isMobile();
            if(nowMobile !== lastIsMobile){ lastIsMobile = nowMobile; renderList(); }
        }, 300));

        // LOADING
        async function loadData(){
            // show skeleton if needed (simple)
            const cached = readCache();
            if(cached){ allGames = cached; renderList(); return; }

            try{
                const res = await fetch(dataUrl);
                if(!res.ok) throw new Error('Сервер не отвечает');
                const data = await res.json();
                if(!data.values || data.values.length <= 1) throw new Error('Пустой прайс');

                allGames = data.values.slice(1).map(r=>{
                    const name = (r[0]||'').trim();
                    const priceRaw = (r[1]||'').trim();
                    const num = Number((priceRaw||'').replace(/\D/g,'')) || 0;
                    return {name, price: priceRaw || '—', num};
                }).filter(g=>g.name && g.price);

                saveCache(allGames);
                renderList();
            }catch(err){
                tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#ff6b6b;padding:3rem;">Ошибка: ${err.message}</td></tr>`;
                cardsList.innerHTML = `<div style="text-align:center;color:#ff6b6b;padding:2rem;">Ошибка загрузки</div>`;
            }
        }

        // initial
        loadData();

    })();
    </script>
</body>
</html>
